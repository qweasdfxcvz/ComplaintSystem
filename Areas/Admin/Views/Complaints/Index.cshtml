@model List<ComplaintSystem.Models.Complaint>
@{
    ViewData["Title"] = "عرض الشكاوي";
    Layout = "~/Areas/Admin/Views/Shared/AdminLayout.cshtml";
    var search = Context.Request.Query["search"].ToString();
    var statusId = Context.Request.Query["statusId"].ToString();
    var days = Context.Request.Query["days"].ToString();
    var delayed = Context.Request.Query["delayed"].ToString();
}

<h2 class="mb-4">الشكاوى</h2>

<form method="get" class="row g-2 mb-4">
    <div class="col-md-3">
        <input type="text" name="search" class="form-control" placeholder="بحث عن مواطن أو رقم شكوى..." value="@search" />
    </div>
    <div class="col-md-2">
        <select name="statusId" class="form-select">
            <option value="">كل الحالات</option>
            @foreach (var status in ViewBag.Statuses as List<ComplaintSystem.Models.ComplaintStatus>)
            {
                <option value="@status.StatusId"
                        selected="@(statusId == status.StatusId.ToString() ? "selected" : null)">
                    @status.Name
                </option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <select name="days" class="form-select">
            <option value="">كل الأوقات</option>
            <option value="1" selected="@(days == "1" ? "selected" : null)">آخر 24 ساعة</option>
            <option value="3" selected="@(days == "3" ? "selected" : null)" )>آخر 3 أيام</option>
            <option value="7" selected="@(days == "7" ? "selected" : null)">آخر أسبوع</option>
        </select>
    </div>
    <div class="col-md-2">
        <div class="form-check pt-2">
            <input class="form-check-input" type="checkbox" name="delayed" value="true" @(delayed == "true" ? "checked" : "") />
            <label class="form-check-label">عرض الشكاوى المتأخرة</label>
        </div>
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">تصفية</button>
    </div>
</form>

@if (!Model.Any())
{
    <div class="alert alert-info">لا توجد شكاوى مطابقة لخيارات الفلترة.</div>
}
else
{
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>رقم الشكوى</th>
                <th>اسم المواطن</th>
                <th>الرقم الوطني</th>
                <th>رقم المعاملة</th>
                <th>الحالة</th>
                <th>نوع الشكوى</th>
                <th>تاريخ الإرسال</th>
                <th>متأخرة؟</th>
                <th>خيارات</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var complaint in Model)
            {
                var isDelayed = complaint.StatusId != 5 && (DateTime.Now - complaint.CreatedAt).TotalHours > 48;

                <tr>
                    <td>@complaint.ComplaintNumber</td>
                    <td>@complaint.CitizenName</td>
                    <td>@complaint.NationalId</td>
                    <td>@complaint.TransactionNo</td>
                    <td>@complaint.Status?.Name</td>
                    <td>@complaint.ComplaintType?.Name</td>
                    <td>@complaint.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>
                        @if (isDelayed)
                        {
                            <span class="badge bg-danger">نعم</span>
                        }
                        else
                        {
                            <span class="badge bg-success">لا</span>
                        }
                    </td>
                    <td>
                        <a class="btn btn-sm btn-info" asp-area="Admin" asp-controller="Complaints" asp-action="Details" asp-route-id="@complaint.ComplaintId">
                            عرض التفاصيل
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

